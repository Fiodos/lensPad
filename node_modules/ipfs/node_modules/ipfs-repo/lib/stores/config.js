'use strict';

var bl = require('bl');

exports = module.exports;

exports.setUp = function (basePath, blobStore, locks) {
  var store = blobStore(basePath);
  return {
    get: function get(callback) {
      store.createReadStream('config').pipe(bl(function (err, config) {
        if (err) {
          return callback(err);
        }
        var result = void 0;
        try {
          result = JSON.parse(config.toString());
        } catch (err) {
          return callback(err);
        }
        callback(null, result);
      }));
    },

    set: function set(config, callback) {
      locks.lock(function (err) {
        if (err) {
          return callback(err);
        }

        store.createWriteStream('config').once('finish', function () {
          locks.unlock(callback);
        }).end(JSON.stringify(config, null, 2));
      });
    }
  };
};