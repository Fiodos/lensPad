'use strict';

var bl = require('bl');

exports = module.exports;

exports.setUp = function (basePath, blobStore, locks) {
  var store = blobStore(basePath);

  return {
    exists: function exists(callback) {
      store.exists('version', callback);
    },
    get: function get(callback) {
      store.createReadStream('version').pipe(bl(function (err, version) {
        if (err) {
          return callback(err);
        }
        callback(null, version.toString('utf8'));
      }));
    },
    set: function set(value, callback) {
      locks.lock(function (err) {
        if (err) {
          return callback(err);
        }

        store.createWriteStream('version').once('finish', function () {
          locks.unlock(callback);
        }).end(value);
      });
    }
  };
};